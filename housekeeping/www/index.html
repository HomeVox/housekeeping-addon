<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housekeeping</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        h1 { font-size: 28px; font-weight: 300; margin-bottom: 30px; }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .brand-subtitle {
            color: #666;
        }

        .vox {
            color: #03a9f4;
        }

        .keeping {
            color: #03a9f4;
        }

        .card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-item { flex: 1; }

        .status-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .status-value { font-size: 20px; font-weight: 500; }

        .ok { color: #4caf50; }
        .warn { color: #ff9800; }
        .error { color: #f44336; }

        .btn {
            background: #03a9f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 8px;
        }

        .btn:hover { background: #0288d1; }
        .btn:disabled { background: #333; color: #666; cursor: default; }

        .btn.secondary {
            background: transparent;
            border: 1px solid #444;
            color: #e0e0e0;
        }

        .btn.secondary:hover { border-color: #666; }
        .btn.secondary:disabled { border-color: #333; color: #555; }

        .btn.danger { background: #c62828; }
        .btn.danger:hover { background: #e53935; }

        .btn.small {
            padding: 4px 10px;
            font-size: 11px;
            margin: 0;
        }

        .version {
            text-align: center;
            color: #444;
            font-size: 12px;
            margin-top: 40px;
        }

        pre {
            background: #0d0d0d;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 10px;
        }

        /* Action groups */
        .group {
            background: #111;
            border: 1px solid #222;
            border-radius: 6px;
            margin-top: 12px;
            overflow: hidden;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #161616;
            cursor: pointer;
            user-select: none;
        }

        .group-header:hover { background: #1c1c1c; }

        .group-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .group-icon { font-size: 16px; }

        .group-badge {
            background: #2a2a2a;
            color: #999;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 400;
        }

        .group-toggle {
            font-size: 11px;
            color: #03a9f4;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 3px;
            background: #0a2a3a;
        }

        .group-toggle:hover { background: #0d3a4f; }

        .group-body { display: none; }
        .group.open .group-body { display: block; }

        .group-chevron {
            color: #555;
            transition: transform 0.2s;
            margin-right: 10px;
        }

        .group.open .group-chevron { transform: rotate(90deg); }

        .action-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 16px;
            border-top: 1px solid #1a1a1a;
            font-size: 13px;
        }

        .action-row:hover { background: #151515; }

        .action-row input[type="checkbox"] {
            margin-top: 3px;
            accent-color: #03a9f4;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .action-info { flex: 1; min-width: 0; }

        .action-entity {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #ccc;
            word-break: break-all;
        }

        .action-reason {
            font-size: 11px;
            color: #777;
            margin-top: 2px;
        }

        .action-confidence {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .conf-high { background: #1b3a1b; color: #4caf50; }
        .conf-mid { background: #3a2a0a; color: #ff9800; }
        .conf-low { background: #3a1a1a; color: #f44336; }

        .action-row.applied {
            opacity: 0.6;
            background: #0a1a0a;
            border-left: 3px solid #4caf50;
        }
        .action-row.applied .action-entity { text-decoration: line-through; color: #666; }
        .action-row.applied .action-status { color: #4caf50; font-size: 11px; font-weight: 500; }

        .action-row.skipped {
            opacity: 0.5;
            background: #1a1a0a;
            border-left: 3px solid #ff9800;
        }
        .action-row.skipped .action-status { color: #ff9800; font-size: 11px; font-weight: 500; }

        .approval-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            background: #3a2a0a;
            color: #ff9800;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .ignore-btn {
            background: none;
            border: 1px solid #333;
            color: #666;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .ignore-btn:hover { border-color: #f44336; color: #f44336; }

        .selection-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px 0;
        }

        .selection-count {
            font-size: 13px;
            color: #999;
        }

        .ignored-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .ignored-bar a {
            color: #03a9f4;
            cursor: pointer;
            text-decoration: none;
            font-size: 11px;
        }
        .ignored-bar a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>House<span class="keeping">keeping</span></h1>
        <div class="brand">
            <div class="brand-subtitle">by Home<span class="vox">Vox</span></div>
        </div>

        <!-- System Status -->
        <div class="card">
            <h3 style="margin-bottom: 20px;">System Status</h3>
            <div class="status">
                <div class="status-item">
                    <div class="status-label">API</div>
                    <div class="status-value ok" id="api-status">Running</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Home Assistant</div>
                    <div class="status-value" id="ha-status">Checking...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Issues Found</div>
                    <div class="status-value" id="issues-count">0</div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <h3 style="margin-bottom: 15px;">Housekeeping Actions</h3>
            <button class="btn" onclick="runPlan()" id="analyze-btn">Analyze</button>
            <button class="btn secondary" onclick="runApply()" id="apply-btn" disabled>Apply</button>
            <button class="btn secondary" onclick="ignoreSelected()" id="ignore-btn" disabled>Ignore selected</button>
            <button class="btn secondary" onclick="runRollback()" id="rollback-btn" disabled>Rollback</button>

            <div id="groups-container"></div>

            <div class="selection-bar" id="selection-bar" style="display: none;">
                <span class="selection-count" id="selection-count"></span>
            </div>

            <div class="ignored-bar" id="ignored-bar" style="display: none;">
                <span id="ignored-count-label"></span>
                <a onclick="clearIgnored()">Reset ignored</a>
            </div>

            <pre id="output" style="display: none;"></pre>
        </div>

        <div class="version">v2.0.21 Â· Automated Housekeeping</div>
    </div>

    <script>
        const BASE = new URL('.', document.baseURI).href.replace(/\/+$/, '');
        let currentPlan = null;
        let areaNameById = {};
        let actionDataById = {};

        const TYPE_META = {
            set_entity_area:             { icon: 'ðŸ“', label: 'Assign area (entities)' },
            set_device_area:             { icon: 'ðŸ“', label: 'Assign area (devices)' },
            remove_entity_registry_entry:{ icon: 'ðŸ—‘ï¸', label: 'Remove duplicates' },
            hide_entity:                 { icon: 'ðŸ‘ï¸', label: 'Hide entities' },
            rename_entity:               { icon: 'âœï¸', label: 'Rename entities' },
            rename_device:               { icon: 'âœï¸', label: 'Rename devices' },
            rename_area:                 { icon: 'âœï¸', label: 'Rename areas' },
            create_area:                 { icon: 'âž•', label: 'Create areas' },
        };

        function actionFingerprint(action) {
            const p = action.payload || {};
            const key = p.entity_id || p.device_id || p.area_id || p.name || '';
            return `${action.type}:${key}`;
        }

        function confClass(c) {
            if (c >= 0.9) return 'conf-high';
            if (c >= 0.7) return 'conf-mid';
            return 'conf-low';
        }

        function entityLabel(action) {
            const p = action.payload || {};
            let label = p.entity_id || p.device_id || p.name || p.area_id || 'â€”';
            if ((action.type === 'set_entity_area' || action.type === 'set_device_area') && p.area_id) {
                const areaName = areaNameById[p.area_id] || p.area_id;
                label += ` <span style="color:#03a9f4">&rarr; ${areaName}</span>`;
            }
            if (action.type === 'rename_entity' && p.name) {
                label += ` <span style="color:#03a9f4">&rarr; ${p.name}</span>`;
            }
            return label;
        }

        function updateSelectionCount() {
            const all = document.querySelectorAll('#groups-container input[type="checkbox"].action-cb:not(:disabled)');
            const checked = document.querySelectorAll('#groups-container input[type="checkbox"].action-cb:checked:not(:disabled)');
            const bar = document.getElementById('selection-bar');
            const count = document.getElementById('selection-count');
            const applyBtn = document.getElementById('apply-btn');
            const ignoreBtn = document.getElementById('ignore-btn');

            bar.style.display = all.length > 0 ? 'flex' : 'none';
            count.textContent = `${checked.length} of ${all.length} selected`;
            applyBtn.disabled = checked.length === 0;
            applyBtn.textContent = checked.length > 0 ? `Apply (${checked.length})` : 'Apply';
            ignoreBtn.disabled = checked.length === 0;
            ignoreBtn.textContent = checked.length > 0 ? `Ignore selected (${checked.length})` : 'Ignore selected';
        }

        function toggleGroup(el) {
            el.closest('.group').classList.toggle('open');
        }

        function toggleAllInGroup(groupEl) {
            const cbs = groupEl.querySelectorAll('input[type="checkbox"].action-cb:not(:disabled)');
            const allChecked = [...cbs].every(cb => cb.checked);
            cbs.forEach(cb => cb.checked = !allChecked);
            updateSelectionCount();
        }

        async function ignoreAction(actionId, rowEl) {
            const action = actionDataById[actionId];
            if (!action) return;
            const fp = actionFingerprint(action);

            try {
                await fetch(BASE + '/api/ignore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprints: [fp] })
                });
                // Remove row from UI with animation
                rowEl.style.transition = 'opacity 0.3s, max-height 0.3s';
                rowEl.style.opacity = '0';
                rowEl.style.maxHeight = '0';
                rowEl.style.overflow = 'hidden';
                setTimeout(() => {
                    const group = rowEl.closest('.group');
                    rowEl.remove();
                    // Update group badge
                    if (group) {
                        const remaining = group.querySelectorAll('.action-row').length;
                        const badge = group.querySelector('.group-badge');
                        if (remaining === 0) {
                            group.remove();
                        } else if (badge) {
                            badge.textContent = remaining;
                        }
                    }
                    updateSelectionCount();
                    // Update total count
                    const allRows = document.querySelectorAll('#groups-container .action-row').length;
                    document.getElementById('issues-count').textContent = allRows;
                }, 300);
            } catch (e) {
                console.error('Failed to ignore:', e);
            }
        }

        async function ignoreSelected() {
            const checked = document.querySelectorAll('#groups-container input[type="checkbox"].action-cb:checked:not(:disabled)');
            if (checked.length === 0) return;

            const fingerprints = [];
            const rows = [];
            checked.forEach(cb => {
                const action = actionDataById[cb.dataset.id];
                if (action) {
                    fingerprints.push(actionFingerprint(action));
                    rows.push(cb.closest('.action-row'));
                }
            });

            try {
                await fetch(BASE + '/api/ignore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprints })
                });

                // Remove rows with animation
                rows.forEach(row => {
                    row.style.transition = 'opacity 0.3s, max-height 0.3s';
                    row.style.opacity = '0';
                    row.style.maxHeight = '0';
                    row.style.overflow = 'hidden';
                });

                setTimeout(() => {
                    rows.forEach(row => {
                        const group = row.closest('.group');
                        row.remove();
                        if (group) {
                            const remaining = group.querySelectorAll('.action-row').length;
                            if (remaining === 0) {
                                group.remove();
                            } else {
                                const badge = group.querySelector('.group-badge');
                                if (badge) badge.textContent = remaining;
                            }
                        }
                    });
                    updateSelectionCount();
                    const allRows = document.querySelectorAll('#groups-container .action-row').length;
                    document.getElementById('issues-count').textContent = allRows;
                }, 300);
            } catch (e) {
                console.error('Failed to ignore selected:', e);
            }
        }

        async function clearIgnored() {
            try {
                await fetch(BASE + '/api/ignore/clear', { method: 'POST' });
                document.getElementById('ignored-bar').style.display = 'none';
                // Re-analyze to show all actions
                runPlan();
            } catch (e) {
                console.error('Failed to clear ignored:', e);
            }
        }

        function renderActions(actions) {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            actionDataById = {};

            // Store action data for fingerprinting
            actions.forEach(a => { actionDataById[a.id] = a; });

            // Group by type
            const groups = {};
            const typeOrder = [];
            actions.forEach(a => {
                if (!groups[a.type]) {
                    groups[a.type] = [];
                    typeOrder.push(a.type);
                }
                groups[a.type].push(a);
            });

            typeOrder.forEach(type => {
                const items = groups[type];
                const meta = TYPE_META[type] || { icon: 'â€¢', label: type };

                const groupEl = document.createElement('div');
                groupEl.className = 'group open';
                groupEl.innerHTML = `
                    <div class="group-header" onclick="toggleGroup(this)">
                        <div class="group-title">
                            <span class="group-chevron">â–¶</span>
                            <span class="group-icon">${meta.icon}</span>
                            <span>${meta.label}</span>
                            <span class="group-badge">${items.length}</span>
                        </div>
                        <span class="group-toggle" onclick="event.stopPropagation(); toggleAllInGroup(this.closest('.group'))">select all</span>
                    </div>
                    <div class="group-body"></div>
                `;

                const body = groupEl.querySelector('.group-body');

                items.forEach(action => {
                    const defaultOn = !action.requires_approval;
                    const row = document.createElement('div');
                    row.className = 'action-row';
                    row.innerHTML = `
                        <input type="checkbox" class="action-cb" data-id="${action.id}" ${defaultOn ? 'checked' : ''} onchange="updateSelectionCount()">
                        <div class="action-info">
                            <div class="action-entity">${entityLabel(action)}</div>
                            <div class="action-reason">${action.reason}</div>
                        </div>
                        ${action.requires_approval ? '<span class="approval-badge">approval</span>' : ''}
                        <span class="action-confidence ${confClass(action.confidence)}">${Math.round(action.confidence * 100)}%</span>
                        <button class="ignore-btn" onclick="event.stopPropagation(); ignoreAction('${action.id}', this.closest('.action-row'))" title="Ignore this action permanently">ignore</button>
                    `;
                    body.appendChild(row);
                });

                container.appendChild(groupEl);
            });

            updateSelectionCount();
        }

        async function runPlan() {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.textContent = 'Analyzing...';
            document.getElementById('analyze-btn').disabled = true;

            try {
                const res = await fetch(BASE + '/api/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ include_onbekend_fallback: false })
                });
                const data = await res.json();

                if (data.error) {
                    output.textContent = 'HA Error: ' + data.error;
                    document.getElementById('analyze-btn').disabled = false;
                    return;
                }

                const plan = data.plan || {};
                const actions = plan.actions || [];
                const ignoredCount = plan.ignored_count || 0;
                areaNameById = plan.area_name_by_id || {};
                currentPlan = plan;

                // Show ignored count
                const ignoredBar = document.getElementById('ignored-bar');
                if (ignoredCount > 0) {
                    document.getElementById('ignored-count-label').textContent =
                        `${ignoredCount} ignored`;
                    ignoredBar.style.display = 'flex';
                } else {
                    ignoredBar.style.display = 'none';
                }

                const issuesEl = document.getElementById('issues-count');

                if (actions.length > 0) {
                    renderActions(actions);
                    issuesEl.textContent = actions.length;
                    issuesEl.className = 'status-value warn';
                    output.textContent = `Found ${actions.length} issue${actions.length !== 1 ? 's' : ''}`;
                } else {
                    document.getElementById('groups-container').innerHTML = '';
                    document.getElementById('selection-bar').style.display = 'none';
                    output.style.display = 'none';
                    issuesEl.textContent = 'All clear';
                    issuesEl.className = 'status-value ok';
                }
            } catch (e) {
                output.textContent = 'Error: ' + e.message;
            }
            document.getElementById('analyze-btn').disabled = false;
        }

        async function runApply() {
            if (!currentPlan) return;

            const checked = document.querySelectorAll('#groups-container input[type="checkbox"].action-cb:checked');
            const ids = [...checked].map(cb => cb.dataset.id);

            if (ids.length === 0) return;

            document.getElementById('output').style.display = 'block';
            document.getElementById('output').textContent = `Applying ${ids.length} changes...`;
            document.getElementById('apply-btn').disabled = true;

            try {
                const res = await fetch(BASE + '/api/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ approved_action_ids: ids })
                });
                const data = await res.json();

                if (data.error) {
                    document.getElementById('output').textContent = 'Error: ' + data.error;
                    document.getElementById('apply-btn').disabled = false;
                    return;
                }

                const appliedIds = new Set(data.applied_action_ids || []);
                const skippedIds = new Set((data.skipped || []).map(s => s.id));

                // Mark each row visually
                document.querySelectorAll('#groups-container .action-row').forEach(row => {
                    const cb = row.querySelector('input.action-cb');
                    if (!cb) return;
                    const id = cb.dataset.id;

                    if (appliedIds.has(id)) {
                        row.classList.add('applied');
                        cb.disabled = true;
                        const ignBtn = row.querySelector('.ignore-btn');
                        if (ignBtn) ignBtn.remove();
                        const status = document.createElement('span');
                        status.className = 'action-status';
                        status.textContent = 'applied';
                        row.appendChild(status);
                    } else if (skippedIds.has(id)) {
                        row.classList.add('skipped');
                        cb.disabled = true;
                        const status = document.createElement('span');
                        status.className = 'action-status';
                        status.textContent = 'skipped';
                        row.appendChild(status);
                    }
                });

                // Update group badges with counts
                document.querySelectorAll('#groups-container .group').forEach(groupEl => {
                    const total = groupEl.querySelectorAll('.action-row').length;
                    const done = groupEl.querySelectorAll('.action-row.applied').length;
                    const skip = groupEl.querySelectorAll('.action-row.skipped').length;
                    const badge = groupEl.querySelector('.group-badge');
                    if (badge && (done > 0 || skip > 0)) {
                        badge.textContent = `${done} applied, ${skip} skipped / ${total}`;
                    }
                });

                const applied = appliedIds.size;
                const skipped = skippedIds.size;
                document.getElementById('output').textContent =
                    `Done! ${applied} applied, ${skipped} skipped.`;
                document.getElementById('rollback-btn').disabled = false;
                updateSelectionCount();

                // If no unchecked actions remain, show all clear
                const remaining = document.querySelectorAll('#groups-container input.action-cb:not(:disabled)').length;
                if (remaining === 0) {
                    const issuesEl = document.getElementById('issues-count');
                    issuesEl.textContent = 'All clear';
                    issuesEl.className = 'status-value ok';
                }
            } catch (e) {
                document.getElementById('output').textContent = 'Error: ' + e.message;
                document.getElementById('apply-btn').disabled = false;
            }
        }

        async function runRollback() {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.textContent = 'Rolling back...';

            try {
                const res = await fetch(BASE + '/api/rollback', { method: 'POST' });
                const data = await res.json();

                if (data.error) {
                    document.getElementById('output').textContent = 'Error: ' + data.error;
                    return;
                }

                document.getElementById('output').textContent =
                    `Rollback complete! ${data.reverted || 0} reverted.`;
                document.getElementById('rollback-btn').disabled = true;
            } catch (e) {
                document.getElementById('output').textContent = 'Error: ' + e.message;
            }
        }

        async function checkHealth() {
            try {
                const res = await fetch(BASE + '/api/health');
                const data = await res.json();

                document.getElementById('api-status').textContent = 'Running';
                document.getElementById('api-status').className = 'status-value ok';

                document.getElementById('ha-status').textContent = data.ha_connected ? 'Connected' : 'Disconnected';
                document.getElementById('ha-status').className = data.ha_connected ? 'status-value ok' : 'status-value error';
            } catch (e) {
                document.getElementById('api-status').textContent = 'Error';
                document.getElementById('api-status').className = 'status-value error';
            }
        }

        checkHealth();
        setInterval(checkHealth, 10000);
    </script>
</body>
</html>
